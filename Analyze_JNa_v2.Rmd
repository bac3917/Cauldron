---
title: "Johnson-Neyman Analysis of Potential Moderator in PEX Data"
author: "BAC"
date: "July 16, 2017"
output: 
        html_document:
                toc: TRUE
                theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(RCurl)
# read file with the outpur (SPSS) from Mayer's PROCESS method 
require(ggplot2)
PEX.raw<-getURL("https://raw.githubusercontent.com/bac3917/Cauldron/master/JN_PEX071617.csv")
PEX<-read.csv(text=PEX.raw)
PEX2.raw<-getURL("https://raw.githubusercontent.com/bac3917/Cauldron/master/PEX.csv")
PEX2<-read.csv(text=PEX2.raw)
CoTeach<-as.data.frame(read.csv("//filesvr01/Research_and_Evaluation_Group/conferences_articles/TeacherPrep_CoTeaching/Level1_071817.csv"))
```

## Objective & Methods
OBJECTIVE: We are interested in learning whether there is a significant interaction between group membership and our independent varible. There are two methodological hurdles presented by our data:

1. low baseline equivalency
2. no homogeneity of regression slopes

Thus our objective is to analyze the data while addressing these two hurdles.

METHODS: To address hurdles 1 and 2, we are (1) using matching to address equivalency and (2) including an interaction term in the final regression model to address homogeneity. 

Here we show results from a two different PRELIMINARY analyses using the Johnson-Neyman procedure. One result uses PROCESS while another uses the R function "JN". The J-N test is necessary because there was not homogeneity of regression sloprs between the comparison and treatment groups (a violation of the assumptions behind analysis of covariance).

Use Mayer's <a href="http://afhayes.com/spss-sas-and-mplus-macros-and-code.html">PROCESS procedure</a> in SPSS to analyze whether a significant interaction effect exists. Compare to results from Bachl's <a href="https://rpubs.com/bachl/jn-plot">JN function</a> for R. Note that **coding our moderator as 0,1 might be problematic.**


## Results

### Properties of key variables
First, we examined the distribution of key variables.   In our analyses, **ZPR_1** is a zcore of teachers' final self-efficacy score, adjusted by initial self-efficacy. **FIDELmid** is the independent variable (dosage of intervention) and **FIDxGRP** is the interaction between dosage and group membership.


```{r R1, warning=FALSE, echo=FALSE, message=FALSE}

library(psych)
describe(PEX2)[,c(3,4,5,8,9,11)]
```

FIDELmid is the key independent variable and is correlated with self-efficacy.
```{r correl, echo=FALSE, warning=FALSE, message=FALSE}
PEX2c<-cbind(PEX2$ZPR_1,PEX2$FIDELmid)
library(Hmisc)
cor(PEX2c,method="pearson")
```

Basic OLS results show significant interaction term.
```{r ols, echo=FALSE}
ModelOLS<-lm(PEX2$ZPR_1 ~ PEX2$FIDELmid + PEX2$cohort2 + PEX2$cohort2*PEX2$FIDELmid)
summary(ModelOLS)
```

However, the data show that homogeneity of regression slopes assumption is violated. Note the mean values of Efficacy (ZPR1) vary for each group:
```{r homog, warning=FALSE,echo=FALSE}
g1<-ggplot(data=CoTeach,aes(x=CoTeach$FIDELmid,y=CoTeach$ZPR_1))+
        geom_jitter() + geom_smooth(method='lm',se=FALSE, aes(col='Best         Fit'),fullrange=TRUE)+facet_wrap(~CoTeach$TreatmentFlag)+
        scale_y_continuous(breaks = round(seq(min(1.5), max(6), by = 0.5),1))+
        xlab("Preparation Program Dosage")+ylab("Efficacy")
g1

```

### Results from PROCESS
Having found that the interaction term is significant (Pr=0.0245), the second analysis step was to prepare a set of parameters using PROCESS, which reads dependent, independent and moderator variables and produces a matrix of values that are "spotlights" on key values of the moderator. The SPSS command is:

    process vars=ZPR_1 FIDELmid cohort2 FIDxGRP 
    	/y=ZPR_1  
    	/x=FIDELmid  
    	/m=FIDxGRP   /model=1 /quantile=1 /JN=1.


The resulting matrix of variables (Table 1, below) shows the conditional effect of the independent variable on the dependent variable at values of the moderator (cohort2) There is a steady increase in the effect for increasing values of the moderator variable.

**Table 1: Output from PROCESS Procedure**

FIDxGRP|Effect|se|t|p|LLCI|ULCI
------|------|------|------|------|------|------|
  .0000|.1507|.1621|.9301|.3534|-.1687|.4702|
  .2500|.2324|.1651|1.4081|.1606|-.0930|.5578|
  .5000|.3142|.1738|1.8076|.0721|-.0284|.6568|
  .6247|.3549|.1800|1.9713|.0500|.0000|.7098|
  .7500|.3959|.1874|2.1120|.0359|.0264|.7653|
 1.0000|.4776|.2050|2.3296|.0208|.0735|.8817|
 1.2500|.5593|.2256|2.4792|.0140|.1146| 1.0040|
 1.5000|.6410|.2485|2.5799|.0106|.1512| 1.1308|
 1.7500|.7227|.2730|2.6472|.0087|.1845| 1.2609|
 2.0000|.8044|.2989|2.6917|.0077|.2153| 1.3935|
 2.2500|.8861|.3257|2.7210|.0071|.2441| 1.5281|
 2.5000|.9678|.3532|2.7399|.0067|.2715| 1.6642|
 2.7500|1.0495|.3814|2.7518|.0064|.2977| 1.8014|
 3.0000|1.1313|.4100|2.7590|.0063|.3230| 1.9395|
 3.2500|1.2130|.4390|2.7628|.0062|.3475| 2.0784|
 3.5000|1.2947|.4683|2.7644|.0062|.3714| 2.2179|
 3.7500|1.3764|.4979|2.7643|.0062|.3949| 2.3579|
 4.0000|1.4581|.5277|2.7632|.0062|.4179| 2.4983|
 4.2500|1.5398|.5576|2.7613|.0063|.4405| 2.6391|
 4.5000|1.6215|.5877|2.7589|.0063|.4629| 2.7801|
 4.7500|1.7032|.6180|2.7561|.0064|.4850| 2.9214|
 5.0000|1.7849|.6483|2.7532|.0064|.5069| 3.0629|


Descriptive statistics for these variables are as follows:

``` {r table, warning= FALSE ,echo=FALSE}

describe(PEX)[,c(3,4,5,8,9,11)]

```

#### Plotting moderator and dependent variable
To illustrate the relationship of the moderating effect of group, we plotted Effect and the interaction term (FIDxGRP) below (Figure 1).  The resulting graph shows that while the lower values of the moderatorinteraction term are not significant (having a t-test value of less than 1.96), most of the interactions between the independent variable and group members (treatment and comparison groups) appear statistically significant.  The green shading shows upper and lower boundaries using the standard error for each calculated level of the moderating variable FIDxGRP.


**Figure 1:  JN Analysis Plotted**

```{r JN2, echo=FALSE}
# use geom_line and geom_ribbon together...
# question is: Where along this continuum are there sig interaction effects?
# add confidence range using SE
PEX$LB<-PEX$Effect - PEX$se   #creating upper and lower bounds with standard error
PEX$UB<-PEX$Effect + PEX$se

ggplot(data=PEX, aes(FIDxGRP)) + 
        geom_line(aes(y=Effect))+
        geom_ribbon(aes(ymin= PEX$LB,ymax=PEX$UB), fill='green',alpha=0.2)+
        geom_text(aes(label=se,y=Effect),angle='90',vjust=-8,colour='blue')+
        geom_vline(xintercept=0.6247, na.rm = FALSE, show.legend = NA, linetype=2)+
        annotate("text", x = 2, y = 2.5, label = "Standard Errors are labeled in blue")+
        annotate("text", x = 2, y = 2, label = " t >= 1.96 when FIDxGRP >= .62")

```


### Results from Bachl's JN Function

Bachl developed a JN function for R and the results are useful to compare to results from PROCESS.

**NOTE:** Bachl writes that these results are not meaningful when the moderator is coded 0 and 1. Need to think this through more.

``` {r Bachl, echo=FALSE, warning=FALSE, message=FALSE}
jnt = function(.lm, predictor, moderator, alpha=.05) {
  require(stringi)
  b1 = coef(.lm)[predictor]
  b3 = coef(.lm)[stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor))]
  se_b1 = coef(summary(.lm))[predictor, 2]
  se_b3 = coef(summary(.lm))[stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor)), 2]
  COV_b1b3 = vcov(.lm)[predictor, stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor))]
  t_crit = qt(1-alpha/2, .lm$df.residual)
  # see Bauer & Curran, 2005
  a = t_crit^2 * se_b3^2 - b3^2
  b = 2 * (t_crit^2 * COV_b1b3 - b1 * b3)
  c = t_crit^2 * se_b1^2 - b1^2
  jn = c(
    (-b - sqrt(b^2 - 4 * a * c)) / (2 * a),
    (-b + sqrt(b^2 - 4 * a * c)) / (2 * a)
  )
  JN = sort(unname(jn))
  JN = JN[JN>=min(.lm$model[,moderator]) & JN<=max(.lm$model[,moderator])]
  JN
}

PEX_<-getURL("https://raw.githubusercontent.com/bac3917/Cauldron/master/PEX.csv")
PEX_<-read.csv(text=PEX_)
 
PEXb = lm(PEX_$ZPR_1 ~ PEX_$FIDELmid * PEX_$cohort2)
jnt(PEXb, predictor = "PEX_$FIDELmid", moderator = "PEX_$cohort2", alpha = .05)
```

```{r thetaplot, echo=FALSE, warning=FALSE, message=FALSE}
theta_plot = function(.lm, predictor, moderator, alpha=.05, jn=F) {
  require(dplyr)
  require(ggplot2); theme_set(theme_minimal())
  require(stringi)
  .data = data_frame(b1 = coef(.lm)[predictor],
                     b3 = coef(.lm)[stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor))],
                     Z = quantile(.lm$model[,moderator], seq(0,1,.01)),
                     theta = b1 + Z * b3,
                     se_b1 = coef(summary(.lm))[predictor, 2],
                     COV_b1b3 = vcov(.lm)[predictor, stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor))],
                     se_b3 = coef(summary(.lm))[stri_startswith_fixed(names(coef(.lm)), paste0(predictor,":")) | stri_endswith_fixed(names(coef(.lm)), paste0(":",predictor)), 2],
                     se_theta = sqrt(se_b1^2 + 2 * Z * COV_b1b3 + Z^2 * se_b3^2),
                     ci.lo_theta = theta+qt(alpha/2, .lm$df.residual)*se_theta,
                     ci.hi_theta = theta+qt(1-alpha/2, .lm$df.residual)*se_theta)
  if (jn) {
    JN = jnt(.lm=.lm, predictor=predictor, moderator=moderator, alpha=alpha)
    JN_lines = geom_vline(xintercept=JN, linetype=2)
    JN_regions = ifelse(length(JN) == 0, "no significance regions", paste(round(JN,2), collapse = "; "))
    Xlab = paste0(moderator, " (JN Significance Regions: ", JN_regions,")")
  }
  else {
    Xlab = moderator
    JN_lines = NULL
  }
  .data %>%
    ggplot(aes(Z, theta, ymin=ci.lo_theta, ymax=ci.hi_theta)) + geom_ribbon(alpha = .2) + geom_line() + ggtitle(paste("Conditional Effect of", predictor, "as function of", moderator)) + geom_hline(yintercept=0, linetype=2) + labs(x = Xlab, y=expression(theta)) + JN_lines
}

theta_plot(PEXb, predictor = "PEX_$FIDELmid", moderator = "PEX_$cohort2",  alpha = .05, jn = F)
tmp_plot<-theta_plot(PEXb, predictor = "PEX_$FIDELmid", moderator = "PEX_$cohort2",  alpha = .05, jn = T)
class(tmp_plot)
tmp_plot
```
